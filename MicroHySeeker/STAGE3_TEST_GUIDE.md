# 阶段3配液功能测试指南

## 测试环境
- 项目: MicroHySeeker
- 阶段: 阶段3 - 配液功能
- 日期: 2026-02-03

---

## ✅ 已完成的功能

### 1. 后端模块
- ✅ `src/echem_sdl/services/logger_service.py` - 日志服务
- ✅ `src/echem_sdl/hardware/diluter.py` - 配液器驱动
- ✅ `src/services/rs485_wrapper.py` - 配液接口集成
- ✅ `src/dialogs/prep_solution.py` - 配液对话框（后端集成完成）

### 2. 测试代码
- ✅ `tests/test_diluter.py` - 单元测试（6个测试全部通过）
- ✅ `test_stage3_integration.py` - 集成测试（4个测试全部通过）
- ✅ `test_stage3_complete.py` - 完整测试（Mock模式通过）

---

## 📋 UI测试步骤（Mock模式）

### 测试1: 配置通道

1. **启动UI**
   ```bash
   conda activate MicroHySeeker
   python run_ui.py
   ```

2. **打开配置对话框**
   - 点击菜单: `设置` -> `配置`
   - 或点击工具栏的配置图标

3. **配置RS485连接**
   - 确认 **Mock模式** 复选框已勾选 ✅
   - 端口选择任意（如COM3）
   - 波特率: 38400
   - 点击 **连接** 按钮
   - 应显示"✅ 连接成功"

4. **配置配液通道**
   - 切换到 **配液通道** 标签页
   - 添加测试通道：
     * 溶液名称: `H2SO4`
     * 原浓度: `1.00` mol/L
     * 泵地址: `1`
     * 方向: `正向`
     * 转速: `120` RPM
     * 颜色: 红色（点击颜色按钮选择）
   - 点击 **添加通道** 按钮
   
5. **添加第二个通道**
   - 溶液名称: `NaOH`
   - 原浓度: `2.00` mol/L
   - 泵地址: `2`
   - 点击 **添加通道**

6. **保存配置**
   - 点击 **保存配置** 按钮
   - 应显示"配置已保存"

### 测试2: 执行配液

1. **打开配液对话框**
   - 点击菜单: `操作` -> `配制溶液`
   - 或点击工具栏的配液图标（绿色烧杯）

2. **设置配液参数**
   - 应该看到刚才配置的两个溶液
   - 设置目标浓度：
     * H2SO4: `0.10` mol/L
     * NaOH: `0.10` mol/L
   - 总体积: `1.00` mL (即1000μL)

3. **开始配制**
   - 点击 **开始配制** 按钮
   - 观察控制台输出：
     ```
     ✅ RS485Wrapper: 配置通道 H2SO4 (地址=1)
     ✅ RS485Wrapper: 配置通道 NaOH (地址=2)
     [INFO] 开始注液: H2SO4, 体积=100.00μL, 转速=120RPM
     [INFO] H2SO4 开始Mock注液，预计 0.5 秒完成
     [INFO] H2SO4 注液完成 (Mock): 100.00μL
     [INFO] 开始注液: NaOH, 体积=50.00μL, 转速=120RPM
     [INFO] NaOH 注液完成 (Mock): 50.00μL
     ```
   - 进度条应从0%增长到100%
   - 状态标签应显示"配液完成"

4. **验证结果**
   - ✅ H2SO4注入量: 100μL（计算：0.1/1.0 × 1000 = 100）
   - ✅ NaOH注入量: 50μL（计算：0.1/2.0 × 1000 = 50）
   - ✅ Mock模式下完成时间约0.5-1秒

### 测试3: 溶剂填充

1. **重新打开配液对话框**

2. **设置参数**
   - H2SO4目标浓度: `0.05` mol/L
   - NaOH目标浓度: `0`（或不设置）
   - NaOH勾选 **是否溶剂** 复选框 ✅
   - 总体积: `2.00` mL

3. **执行配制**
   - H2SO4应注入: 100μL（0.05/1.0 × 2000 = 100）
   - NaOH作为溶剂应注入: 1900μL（2000 - 100 = 1900）

---

## 🔧 硬件测试步骤

⚠️ **前提**: Mock模式测试必须全部通过

### 测试4: 真实硬件配液

1. **准备硬件**
   - 连接RS485转USB线到电脑
   - 确认COM口号（如COM3）
   - 至少连接1个泵到RS485总线
   - 泵地址设置为1

2. **切换到硬件模式**
   - 打开配置对话框
   - **取消勾选** Mock模式 ❌
   - 选择正确的COM口
   - 点击 **连接**
   - 点击 **扫描泵** 确认设备在线

3. **配置通道**
   - 配置1个测试通道（泵地址1）
   - 保存配置

4. **小体积测试**
   - 打开配液对话框
   - 设置小体积（建议10-50μL）
   - 点击开始配制
   - **观察**:
     * 泵应该开始转动
     * 进度条显示进度
     * 泵停止转动
     * 显示"配液完成"

5. **验证**
   - ✅ 泵实际运转
   - ✅ 注液量准确（可通过称重或体积标记验证）
   - ✅ UI显示准确进度
   - ✅ 无通信错误

---

## 🐛 问题排查

### 问题1: UI无法启动
```bash
# 检查依赖
conda activate MicroHySeeker
pip list | grep -E "PySide6|pyserial"

# 重新安装
pip install PySide6 pyserial
```

### 问题2: 连接失败（Mock模式）
- Mock模式不应失败，检查代码是否有错误
- 查看终端输出的错误信息

### 问题3: 连接失败（硬件模式）
```bash
# 检查COM口
python -c "from src.services.rs485_wrapper import get_rs485_instance; print(get_rs485_instance().list_available_ports())"

# 测试串口连接
python test_stage3_complete.py
# 选择 'y' 测试硬件
```

### 问题4: 配液无响应
- 检查是否已在配置对话框中连接RS485
- 检查是否已配置配液通道
- 查看控制台日志

### 问题5: 真实泵不转
- 检查泵地址是否正确
- 检查RS485总线连接
- 尝试使用手动控制测试泵（菜单: 工具 -> 手动控制）

---

## ✅ 完成标志

### Mock模式验证
- [ ] 能成功配置配液通道
- [ ] 能执行配液操作
- [ ] 进度显示正确
- [ ] 体积计算准确
- [ ] 控制台日志完整

### 硬件模式验证
- [ ] 能连接真实设备
- [ ] 能扫描到泵
- [ ] 泵实际运转
- [ ] 注液量准确
- [ ] 无通信错误

---

## 📊 预期结果

### Mock模式
- 配液立即完成（模拟时间0.5秒/100μL）
- 控制台显示完整日志
- 进度条平滑更新

### 硬件模式
- 泵按设定转速运转
- 注液量符合计算值（±5%误差可接受）
- 配液时间符合预期
- 无RS485通信错误

---

## 🎯 下一步

完成所有测试后：
1. 更新 `DEVELOPMENT_PROGRESS.md`
2. 记录测试结果
3. 进入阶段4：冲洗功能开发
